<!DOCTYPE html>
<html lang="zh-tw"><head>
  <meta charset="utf-8">
  <title>
    
    全台空氣指標儀表板-Javascript新手地下城
    
  </title>
  <!-- mobile responsive meta -->
  <meta name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description"
    content="六角學院Javscript新手地下城5F空氣品質AQI">
  
  <meta name="author"
    content="Leo">
  <meta name="generator" content="Hugo 0.68.3" />

  <!-- plugins -->
  
  <link rel="stylesheet"
    href="https://bjmqfg83.github.io/plugins/bootstrap/bootstrap.min.css ">
  
  <link rel="stylesheet"
    href="https://bjmqfg83.github.io/plugins/slick/slick.css ">
  
  <link rel="stylesheet"
    href="https://bjmqfg83.github.io/plugins/themify-icons/themify-icons.css ">
  
  <link rel="stylesheet"
    href="https://bjmqfg83.github.io/plugins/venobox/venobox.css ">
  

  <!-- Main Stylesheet -->
  
  <link rel="stylesheet"
    href="https://bjmqfg83.github.io/scss/style.min.css"
    media="screen">

  <!--Favicon-->
  <link rel="shortcut icon"
    href="https://bjmqfg83.github.io/images/favicon.png "
    type="image/x-icon">
  <link rel="icon"
    href="https://bjmqfg83.github.io/images/favicon.png "
    type="image/x-icon">

  

</head><body>
<!-- preloader start -->
<div class="preloader">
  
</div>
<!-- preloader end -->
<!-- navigation -->
<header class="navigation">
  <div class="container">
    
    <nav class="navbar navbar-expand-lg navbar-white bg-transparent border-bottom pl-0">
      <a class="navbar-brand mobile-view text-dark"
        href="https://bjmqfg83.github.io"><img class="img-fluid header-logo mr-3"
          src="https://bjmqfg83.github.io/images/favicon.png"
          alt="Leo&#39;s blog">Leo&#39;s blog</a>
      <button class="navbar-toggler border-0"
        type="button"
        data-toggle="collapse"
        data-target="#navigation">
        <i class="ti-menu h3"></i>
      </button>

      <div class="collapse navbar-collapse text-center"
        id="navigation">
        

        <a class="navbar-brand mr-auto desktop-view text-dark"
          href="https://bjmqfg83.github.io"><img class="img-fluid header-logo mr-3"
            src="https://bjmqfg83.github.io/images/favicon.png"
            alt="Leo&#39;s blog">Leo&#39;s blog</a>

        <ul class="navbar-nav">
          
          
          <li class="nav-item">
            <a class="nav-link"
              href="https://bjmqfg83.github.io/">Home</a>
          </li>
          
          
          
          <li class="nav-item">
            <a class="nav-link"
              href="https://bjmqfg83.github.io/about">About</a>
          </li>
          
          
        </ul>

        
        <!-- search -->
        <div class="search pl-lg-4">
          <button id="searchOpen"
            class="search-btn"><i class="ti-search"></i></button>
          <div class="search-wrapper">
            <form action="https://bjmqfg83.github.io/search"
              class="h-100">
              <input class="search-box px-4"
                id="search-query"
                name="s"
                type="search"
                placeholder="Type & Hit Enter...">
            </form>
            <button id="searchClose"
              class="search-close"><i class="ti-close text-dark"></i></button>
          </div>
        </div>
        

        
      </div>
    </nav>
  </div>
</header>
<!-- /navigation -->
<section class="section-sm article-container">
  <div class="container">
    <div class="row">
      <div class="col-lg-10 mx-auto">
        <h2 class="article-font">全台空氣指標儀表板-Javascript新手地下城</h2>
        <div class="mb-3 post-meta">
          <span>By Leo</span>
          
          <span class="border-bottom border-primary px-2 mx-1"></span>
          <span>11 February 2021</span>
          
          <span class="border-bottom border-primary px-2 mx-1"></span>
          
          <a href="/categories/javascript"
            class="text-primary">Javascript</a>
          
        </div>
        
        <img src="https://bjmqfg83.github.io/images/post/hex_aqi.png"
          class="img-fluid w-100 mb-4"
          alt="全台空氣指標儀表板-Javascript新手地下城">
        
        <div class="content mb-5 article">
          <h3 id="使用技術">使用技術</h3>
<p>JS : Vue、axios、For迴圈、Regular expressions、Array</p>
<p>CSS: SCSS(CSS前處理語言)、flex、customize scrollbar</p>
<p>Others: google fonts、政府資料開放平台-空氣品質指標(AQI)</p>
<h3 id="開發歷程">開發歷程</h3>
<p>想要專注在邏輯上所以使用框架開發,當資料更新時由Vue負責畫面渲染</p>
<p>資料的取得使用axios這個套件串接<a href="https://data.gov.tw/dataset/40448">政府資料開放平台</a>的API，另外頁面的部分做了一個假的selection方便客製化CSS樣式，其餘js程式邏輯使用forEach過濾出符合條件的資料、正規表示法調整更新時間顯示的格式</p>
<h3 id="xmlhttprequest">XMLHttpRequest</h3>
<p>在提交表單資料、串接API這種非同步行為時會希望過程中仍可以對網頁進行操作及瀏覽</p>
<p>這時候我們可以透過<a href="https://developer.mozilla.org/zh-TW/docs/Web/API/XMLHttpRequest">XMLHttpRequest</a>讓網頁在進行非同步的操作時不會卡住或是重整</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#999;font-style:italic">//Step 1 創建異步物件
</span><span style="color:#999;font-style:italic"></span> <span style="color:#6ab825;font-weight:bold">var</span> xhr = <span style="color:#6ab825;font-weight:bold">new</span> XMLHttpRequest(); <span style="color:#999;font-style:italic">//可以簡稱xhr物件
</span><span style="color:#999;font-style:italic">//Step 2 創建異步請求
</span><span style="color:#999;font-style:italic">// method為http請求(get、post...)、url為請求路徑、async為為非同步設定,true為非同步、false為同步
</span><span style="color:#999;font-style:italic"></span>xhr.open(method, url, async);
<span style="color:#999;font-style:italic">//3.設定監聽事件
</span><span style="color:#999;font-style:italic">// 當xhr物件接受到server的嚮應且響應狀態為200(ok)時進行後續處理
</span><span style="color:#999;font-style:italic"></span>xhr.onreadystatechange = <span style="color:#6ab825;font-weight:bold">function</span> () {
    <span style="color:#6ab825;font-weight:bold">if</span> (xhr.readyState === <span style="color:#3677a9">4</span> &amp;&amp; xhr.status === <span style="color:#3677a9">200</span>) {
        <span style="color:#999;font-style:italic">// 取得響應的訊息
</span><span style="color:#999;font-style:italic"></span>        <span style="color:#6ab825;font-weight:bold">var</span> resText = xhr.responseText;
    }
}
<span style="color:#999;font-style:italic">// 4.送出請求，send參數除post以外都給null
</span><span style="color:#999;font-style:italic"></span>xhr.send(<span style="color:#6ab825;font-weight:bold">null</span>);
</code></pre></div><p>如果是post請求的話需要額外設定<strong>RequestHeader</strong>，告知server要提交的資料類型並把資料放置send提交</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#999;font-style:italic">// 以表單資料為例
</span><span style="color:#999;font-style:italic"></span>xhr.setRequestHeader(<span style="color:#ed9d13">&#39;Content-Type&#39;</span>, <span style="color:#ed9d13">&#39;application/x-www-form-urlencoded&#39;</span>);
<span style="color:#6ab825;font-weight:bold">var</span> msg = <span style="color:#ed9d13">&#39;data1=&#39;</span> + 資料1 +<span style="color:#ed9d13">&#39;&amp;&#39;</span>+ <span style="color:#ed9d13">&#39;data2&#39;</span> + 資料2... ;
xhr.send(msg);
</code></pre></div><p><strong>註: 雖然是叫「XML」HttpRequest但也可以使用純文字或是JSON格式的資料</strong></p>
<h3 id="promise">Promise</h3>
<p>在簡單的專案可能還沒關係，但如果專案的需求須要進行多個請求或是要在請求後進行很多程式的處理的話可能會變成下面這樣</p>
<p><img src="/images/post/callbackhell.jpg" alt=""></p>
<p>圖片來源: <a href="https://medium.com/ninjadevs/node-7-6-koa-2-asynchronous-flow-control-made-right-b0d41c6ba570">Node 7.6 + Koa 2: asynchronous flow control made right</a></p>
<p>這種波動拳的樣子有個別稱叫「<strong>Callback hell 回調地獄</strong>」，這會造成日後程式維護、擴充上的不便，我們可以透過ES6的Promise來改善,這邊簡單概述一下</p>
<p>Promise有以下三種狀態</p>
<ul>
<li>擱置(pending)：初始狀態，表示操作進行中</li>
<li>實現(fulfilled) ：表示操作成功，執行resolve(),可透過then查看結果</li>
<li>拒絕(rejected)： 表示操作失敗，執行reject(),可透過catch查看結果</li>
</ul>
<p><img src="/images/post/promise_intro.svg" alt=""></p>
<p>圖片來源: <a href="https://developer.mozilla.org/zh-TW/docs/Web/JavaScript/Reference/Global_Objects/Promise">Promise MDN</a></p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">  <span style="color:#6ab825;font-weight:bold">function</span> PromiseFn() {
    <span style="color:#6ab825;font-weight:bold">return</span> <span style="color:#6ab825;font-weight:bold">new</span> <span style="color:#24909d">Promise</span>(<span style="color:#6ab825;font-weight:bold">function</span> (resolve, reject) {
      <span style="color:#6ab825;font-weight:bold">var</span> xhr = <span style="color:#6ab825;font-weight:bold">new</span> XMLHttpRequest();
      <span style="color:#999;font-style:italic">// 可以把api_key後面的參數改掉刻意引發CORS的錯誤來執行reject
</span><span style="color:#999;font-style:italic"></span>      xhr.open(<span style="color:#ed9d13">&#34;get&#34;</span>,<span style="color:#ed9d13">&#34;https://data.epa.gov.tw/api/v1/aqx_p_432?limit=1000&amp;api_key=9be7b239-557b-4c10-9775-78cadfc555e9&amp;format=json&#34;</span>);
      <span style="color:#999;font-style:italic">// xhr.onreadystatechange可用onload取代
</span><span style="color:#999;font-style:italic"></span>      xhr.onload = <span style="color:#6ab825;font-weight:bold">function</span>() {
          resolve(JSON.parse(xhr.responseText));
      }
      xhr.onerror = <span style="color:#6ab825;font-weight:bold">function</span>(){
          reject(xhr);
      }
      xhr.send(<span style="color:#6ab825;font-weight:bold">null</span>);
      });
  }
  PromiseFn()
    .then(<span style="color:#6ab825;font-weight:bold">function</span>(res){
      ...
      <span style="color:#6ab825;font-weight:bold">return</span> PromiseFn();
  }).then(<span style="color:#6ab825;font-weight:bold">function</span>(res2){
      ...
      <span style="color:#6ab825;font-weight:bold">return</span> PromiseFn();
  }).then(<span style="color:#6ab825;font-weight:bold">function</span>(res3){
      ...
  }).<span style="color:#6ab825;font-weight:bold">catch</span>(<span style="color:#6ab825;font-weight:bold">function</span>(error){
      ...
});
</code></pre></div><p>這樣就避免了波動拳的產生，後續要繼續進行非同步操作時透過return一個Promise的方式進續進行</p>
<p>Promise還有其他如Promise.all()、Promise.race()等等的方法&hellip;甚至在ES7版本有更好用的Async/Await可以用同步的思維去做非同步的操作，有興趣的朋友可以研究看看</p>
<h3 id="fetch-api">Fetch API</h3>
<p>以前如果想要簡化XMLHttpRequest的寫法通常都會使用jQuery的ajax來做，現在在HTML5的標準內我們有原生的Fetch API可以使用</p>
<p>Fetch API有幾點特性</p>
<ol>
<li>使用Promise做回應</li>
<li>使用then做下一步處理、catch作錯誤處理</li>
<li>一開始的回傳為ReadableStream，需要針對不同的資料類型使用對應方法獲取資料ex:json()、text()、blob()&hellip;</li>
<li>只要server有響應不論status code是<strong>404</strong>或是<strong>500</strong>Promise的狀態都會是fulfilled而不是rejected，這部分需要額外做處理</li>
</ol>
<p>現在看一下程式碼</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">  fetch(<span style="color:#ed9d13">&#39;https://jsonplaceholder.typicode.com/todos/1&#39;</span>)
  .then(res =&gt; {
    console.log(res); <span style="color:#999;font-style:italic">// response的body內可以看到ReadableStream
</span><span style="color:#999;font-style:italic"></span>    <span style="color:#6ab825;font-weight:bold">if</span>(res.ok === <span style="color:#6ab825;font-weight:bold">true</span> || (res.status &gt;= <span style="color:#3677a9">200</span> &amp;&amp; res.status &lt; <span style="color:#3677a9">300</span>)){
      <span style="color:#6ab825;font-weight:bold">return</span> res.json(); <span style="color:#999;font-style:italic">// 將json資料用.json()解析回傳
</span><span style="color:#999;font-style:italic"></span>    }<span style="color:#6ab825;font-weight:bold">else</span>{
      <span style="color:#6ab825;font-weight:bold">throw</span> <span style="color:#6ab825;font-weight:bold">new</span> <span style="color:#24909d">Error</span>(<span style="color:#ed9d13">&#39;Error happen&#39;</span>);
    }
  })
  .then(json =&gt; console.log(json))
  .<span style="color:#6ab825;font-weight:bold">catch</span>(err =&gt; {
    console.error(<span style="color:#ed9d13">&#39;錯誤&#39;</span>, err);
  });
</code></pre></div><p>POST方法一樣要設定header跟body</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">  fetch(url, {
    method: <span style="color:#ed9d13">&#39;POST&#39;</span>,
    <span style="color:#999;font-style:italic">// headers 加入 json 格式
</span><span style="color:#999;font-style:italic"></span>    headers: {
      <span style="color:#ed9d13">&#39;Content-Type&#39;</span>: <span style="color:#ed9d13">&#39;application/json&#39;</span>
    },
    <span style="color:#999;font-style:italic">// body 將 json 轉字串送出
</span><span style="color:#999;font-style:italic"></span>    body: JSON.stringify({
      data_A: <span style="color:#ed9d13">&#39;xxxx&#39;</span>,
      data_B: <span style="color:#ed9d13">&#39;xxxx&#39;</span>
    }).then(res =&gt;{
      <span style="color:#6ab825;font-weight:bold">if</span>(res.ok === <span style="color:#6ab825;font-weight:bold">true</span> || (res.status &gt;= <span style="color:#3677a9">200</span> &amp;&amp; res.status &lt; <span style="color:#3677a9">300</span>)){
        <span style="color:#6ab825;font-weight:bold">return</span> res.json(); <span style="color:#999;font-style:italic">// 將json資料用.json()解析回傳
</span><span style="color:#999;font-style:italic"></span>      }<span style="color:#6ab825;font-weight:bold">else</span>{
        <span style="color:#6ab825;font-weight:bold">throw</span> <span style="color:#6ab825;font-weight:bold">new</span> <span style="color:#24909d">Error</span>(<span style="color:#ed9d13">&#39;Error happen&#39;</span>);
      }
    }).then(jsonData =&gt; {console.log(jsonData)};
    ).<span style="color:#6ab825;font-weight:bold">catch</span>(err =&gt; {
      console.log(<span style="color:#ed9d13">&#39;錯誤:&#39;</span>, err);
    })
</code></pre></div><h3 id="cors">CORS</h3>
<p>CORS全稱為<strong>Cross-Origin Resource Sharing 跨來源資源共享</strong>，瀏覽器基於安全性的考量會限制使用者存取其他來源的資源</p>
<p>以下幾種情況會被當作不同來源</p>
<ol>
<li>不同協定 ex: &quot;https&quot;、&quot;http&quot;</li>
<li>不同domain ex: &quot;https://example.com&quot;、&quot;https://example_others.com&quot;</li>
<li>不同port ex: &quot;https://example.com&quot;、&quot;https://example.com:8080&quot;</li>
</ol>
<p>跟後端協作串接API時如果遇到CORS通常後端會去設定<strong>Access-Control-Allow-Origin</strong>來讓特定來源能夠存取資源或是乾脆使用*號(通配符)讓所有不同來源都能夠存取</p>
<p>但如果要串接的是第三方的API的話可以參考一下六角助教<a href="https://hsiangfeng.github.io/javascript/20190617/3829122039/">Google Apps Script</a>寫的這篇文章去試看看，大概的理解是CORS是因為瀏覽器請求非同源的資源所發生，那就不用瀏覽器去請求來規避這個問題</p>
<p>我用<a href="https://data.gov.tw/dataset/136489">新竹縣政府公務人員參訓人數</a>這個API去試了之後沒問題，但是對於像是需要API_KEY金鑰的API如<a href="https://data.gov.tw/dataset/40448">空氣品質指標(AQI)</a>一樣還是會有CORS的問題發生，所以Google Apps Script只是一個暫時性的方式，實作上還是要因應情況去做調整</p>
<h3 id="aqi-demo連結">AQI Demo連結</h3>







<script
    data-slug-hash="LYbbVJV"
    data-user="mgnlhdsl"
    data-height="600"
    data-default-tab="result"
    data-theme-id="8862"
    class='codepen'
    async
    src="//codepen.io/assets/embed/ei.js"
></script>
<h4 id="參考資料">參考資料:</h4>
<p><a href="https://developer.mozilla.org/zh-TW/docs/Web/API/XMLHttpRequest/readyState">ReadyState MDN</a></p>
<p><a href="https://developer.mozilla.org/zh-TW/docs/Web/JavaScript/Reference/Global_Objects/Promise">Promise MDN</a></p>
<p><a href="https://developer.mozilla.org/zh-TW/docs/Web/API/Fetch_API/Using_Fetch">Fetch MDN</a></p>
<p><a href="https://www.oxxostudio.tw/articles/201908/js-fetch.html">OxxO STUDIO Fetch API 使用教學</a></p>

        </div>

        
        
        
        
        <script src="https://utteranc.es/client.js"
          repo="bjmqfg83/comment-utterances"
          issue-term="title"
          theme="github-light"
          crossorigin="anonymous"
          async>
          </script>
      </div>
    </div>
  </div>
</section>





<script>
  var indexURL = "https://bjmqfg83.github.io/index.json"
</script>

<!-- JS Plugins -->

<script src="https://bjmqfg83.github.io/plugins/jQuery/jquery.min.js"></script>

<script src="https://bjmqfg83.github.io/plugins/bootstrap/bootstrap.min.js"></script>

<script src="https://bjmqfg83.github.io/plugins/slick/slick.min.js"></script>

<script src="https://bjmqfg83.github.io/plugins/venobox/venobox.min.js"></script>

<script src="https://bjmqfg83.github.io/plugins/search/fuse.min.js"></script>

<script src="https://bjmqfg83.github.io/plugins/search/mark.js"></script>

<script src="https://bjmqfg83.github.io/plugins/search/search.js"></script>

<!-- Main Script -->

<script src="https://bjmqfg83.github.io/js/script.min.js"></script>
<!-- google analitycs -->
<script>
  (function (i, s, o, g, r, a, m) {
    i['GoogleAnalyticsObject'] = r;
    i[r] = i[r] || function () {
      (i[r].q = i[r].q || []).push(arguments)
    }, i[r].l = 1 * new Date();
    a = s.createElement(o),
      m = s.getElementsByTagName(o)[0];
    a.async = 1;
    a.src = g;
    m.parentNode.insertBefore(a, m)
  })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
  ga('create', 'UA-176082228-1', 'auto');
  ga('send', 'pageview');
</script></body>
</html>